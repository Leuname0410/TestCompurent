<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compras del Cliente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Bienvenido</h1>
      <div>
        <button id="update-client-btn" class="btn btn-info d-none">Actualizar Datos</button>
        <button id="change-password-btn" class="btn btn-warning d-none">Cambiar Contraseña</button>
      </div>
    </div>
    <div id="user-info"></div>
    <button id="load-purchases" class="btn btn-primary mt-3 d-none">Cargar Compras</button>
    <div id="purchases" class="mt-3"></div>
    <button id="load-albums" class="btn btn-success mt-3 d-none">Ver Álbumes</button>
    <div id="albums" class="row mt-4"></div>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Iniciar Sesión</h5></div>
        <div class="modal-body">
          <div class="mb-3"><label>ID</label><input type="text" id="login-id" class="form-control" /></div>
          <div class="mb-3"><label>Contraseña</label><input type="password" id="login-password" class="form-control" /></div>
          <button id="open-register" class="btn btn-link p-0">¿No tienes cuenta? Regístrate</button>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="login-btn">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Registro Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Registro</h5></div>
        <div class="modal-body">
          <div class="mb-2"><label>ID</label><input id="reg-id" maxlength="10" class="form-control" /></div>
          <div class="mb-2"><label>Nombre</label><input id="reg-name" maxlength="100" class="form-control" /></div>
          <div class="mb-2"><label>Correo</label><input id="reg-mail" type="email" maxlength="50" class="form-control" /></div>
          <div class="mb-2"><label>Dirección</label><input id="reg-direction" maxlength="500" class="form-control" /></div>
          <div class="mb-2"><label>Teléfono</label><input id="reg-phone" maxlength="20" class="form-control" /></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" id="save-client">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cambiar Contraseña Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Cambiar Contraseña</h5></div>
        <div class="modal-body">
          <div class="mb-2"><label>Nueva Contraseña</label><input type="password" id="new-password" class="form-control" /></div>
          <div class="mb-2"><label>Confirmar Contraseña</label><input type="password" id="confirm-password" class="form-control" /></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-warning" id="update-password-btn">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Actualizar Datos Modal -->
  <div class="modal" id="updateClientModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Actualizar Datos</h5></div>
        <div class="modal-body">
          <div class="mb-2"><label>Nombre</label><input id="upd-name" maxlength="100" class="form-control" /></div>
          <div class="mb-2"><label>Correo</label><input id="upd-mail" type="email" maxlength="50" class="form-control" /></div>
          <div class="mb-2"><label>Dirección</label><input id="upd-direction" maxlength="500" class="form-control" /></div>
          <div class="mb-2"><label>Teléfono</label><input id="upd-phone" maxlength="20" class="form-control" /></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="save-updated-client">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let clientData = null;
    let loginModal, registerModal, changePasswordModal, updateClientModal;

    window.onload = () => {
      loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
      changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
      updateClientModal = new bootstrap.Modal(document.getElementById('updateClientModal'));

      loginModal.show();

      document.getElementById('login-btn').onclick = login;
      document.getElementById('open-register').onclick = () => { loginModal.hide(); registerModal.show(); };
      document.getElementById('save-client').onclick = registerClient;
      document.getElementById('change-password-btn').onclick = () => changePasswordModal.show();
      document.getElementById('update-password-btn').onclick = updatePassword;
      document.getElementById('update-client-btn').onclick = () => {
        document.getElementById('upd-name').value = clientData.name;
        document.getElementById('upd-mail').value = clientData.mail;
        document.getElementById('upd-direction').value = clientData.direction;
        document.getElementById('upd-phone').value = clientData.phone;
        updateClientModal.show();
      };
      document.getElementById('save-updated-client').onclick = updateClientData;
    };

    async function login() {
      const id = document.getElementById('login-id').value;
      const password = document.getElementById('login-password').value;

      const res = await fetch('https://localhost:7174/api/Login', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password })
      });

      if (res.status === 401) return Swal.fire('Error', 'Credenciales incorrectas', 'error');
      clientData = await res.json();

      document.getElementById('user-info').innerText = `Cliente: ${clientData.name} (${clientData.clientId})`;
      loginModal.hide();
      document.getElementById('login-id').value = '';
      document.getElementById('login-password').value = '';

      ['load-purchases', 'load-albums', 'change-password-btn', 'update-client-btn'].forEach(id =>
        document.getElementById(id).classList.remove('d-none'));
    }

    async function registerClient() {
      const body = {
        id: document.getElementById('reg-id').value,
        name: document.getElementById('reg-name').value,
        mail: document.getElementById('reg-mail').value,
        direction: document.getElementById('reg-direction').value,
        phone: document.getElementById('reg-phone').value
      };

      const res = await fetch('https://localhost:7174/api/Clients', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        registerModal.hide();
        Swal.fire('¡Registrado!', 'Contraseña predeterminada: <b>MusicRadio</b>', 'success');
        loginModal.show();
      } else {
        Swal.fire('Error', 'No se pudo registrar.', 'error');
      }
    }

    async function updateClientData() {
      const updatedData = {
        name: document.getElementById('upd-name').value,
        mail: document.getElementById('upd-mail').value,
        direction: document.getElementById('upd-direction').value,
        phone: document.getElementById('upd-phone').value
      };

      const res = await fetch(`https://localhost:7174/api/Clients/${clientData.clientId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });

      if (res.ok) {
        updateClientModal.hide();
        Swal.fire('Actualizado', 'Tus datos han sido actualizados.', 'success');
        clientData = { ...clientData, ...updatedData };
        document.getElementById('user-info').innerText = `Cliente: ${clientData.name} (${clientData.clientId})`;
      } else {
        Swal.fire('Error', 'No se pudieron actualizar los datos.', 'error');
      }
    }

    async function updatePassword() {
      const newPassword = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;
      if (newPassword !== confirm) return Swal.fire('Error', 'Las contraseñas no coinciden', 'error');

      const res = await fetch(`https://localhost:7174/api/Login?id=${clientData.clientId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });

      if (res.ok) {
        changePasswordModal.hide();
        Swal.fire('Éxito', 'Contraseña actualizada', 'success');
      } else {
        Swal.fire('Error', 'No se pudo cambiar la contraseña', 'error');
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
